name: Instrument

on:
  workflow_dispatch:

jobs:
  instrument:
    runs-on: self-hosted   # Windows runner

    defaults:
      run:
        shell: powershell
        working-directory: ${{ github.workspace }}\target

    env:
      FusionLiteServerHost: ${{ vars.FUSIONLITE_SERVER_HOST }}
      FusionLiteServerPort: ${{ vars.FUSIONLITE_SERVER_PORT }}
      FusionLiteServerUser: ${{ secrets.FUSIONLITE_SERVER_USER }}
      FusionLiteServerKeyFile: ${{ secrets.FUSIONLITE_SERVER_KEY_FILE }}
      FusionLiteProject: ${{ github.event.repository.name }}
      ApplicationFile: ${{ github.event.repository.name }}.jar
      ApplicationInclude: ""
      ApplicationExclude: ""
      InstrumentedFolder: Instrumented
      InstrumentedFile: ${{ github.event.repository.name }}.jar

    steps:

    - name: Print environment variables
      run: |
        Write-Host "FusionLiteServerHost: $env:FusionLiteServerHost"
        Write-Host "FusionLiteServerPort: $env:FusionLiteServerPort"
        Write-Host "FusionLiteServerUser: $env:FusionLiteServerUser"
        Write-Host "FusionLiteProject: $env:FusionLiteProject"
        Write-Host "ApplicationFile: $env:ApplicationFile"
        Write-Host "InstrumentedFolder: $env:InstrumentedFolder"
        Write-Host "InstrumentedFile: $env:InstrumentedFile"

    - name: Print current working directory
      run: Get-Location

    - name: Create and Secure SSH Key File
      run: |
        # Write key content to file
        Set-Content -Path "id_ecdsa" -Value $env:FusionLiteServerKeyFile

        # Convert CRLF -> LF for OpenSSH
        $content = Get-Content "id_ecdsa" -Raw
        $content = $content -replace "`r`n", "`n"
        $content = $content -replace "`r", "`n"
        Set-Content -Path "id_ecdsa" -Value $content -NoNewline

        # Secure key: only current user can access
        $user = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
        $acl = Get-Acl "id_ecdsa"
        $acl.SetAccessRuleProtection($true, $false) # disable inheritance
        $acl.Access | ForEach-Object { $acl.RemoveAccessRule($_) }
        $rule = New-Object System.Security.AccessControl.FileSystemAccessRule($user, "FullControl", "Allow")
        $acl.AddAccessRule($rule)
        Set-Acl -Path "id_ecdsa" -AclObject $acl

    - name: Clean Project
      run: |
        $cmdtext = "Clean:$env:FusionLiteProject"
        Write-Host "Cmd: $cmdtext"
        ssh -i id_ecdsa -p $env:FusionLiteServerPort `
            "$env:FusionLiteServerUser@$env:FusionLiteServerHost" "$cmdtext"

    - name: Upload Project JAR to Server (SFTP PUT)
      run: |
        @"
        cd $($env:FusionLiteProject)/Input
        put $($env:ApplicationFile)
        exit
        "@ | Set-Content "sftp_put.txt"

        sftp -b sftp_put.txt `
             -i id_ecdsa `
             -P $env:FusionLiteServerPort `
             "$env:FusionLiteServerUser@$env:FusionLiteServerHost"

    - name: Preprocess Project
      run: |
        $cmdtext = "PreProcess:$env:FusionLiteProject"
        ssh -i id_ecdsa -p $env:FusionLiteServerPort `
            "$env:FusionLiteServerUser@$env:FusionLiteServerHost" "$cmdtext"

    - name: Instrument Project
      run: |
        $cmdtext = "Instrument:$env:FusionLiteProject"
        ssh -i id_ecdsa -p $env:FusionLiteServerPort `
            "$env:FusionLiteServerUser@$env:FusionLiteServerHost" "$cmdtext"

    - name: PostProcess Project
      run: |
        $cmdtext = "PostProcess:$env:FusionLiteProject"
        ssh -i id_ecdsa -p $env:FusionLiteServerPort `
            "$env:FusionLiteServerUser@$env:FusionLiteServerHost" "$cmdtext"

    - name: Download Instrumented JAR (SFTP GET)
      run: |
        # Cleanup & recreate folder
        if (Test-Path $env:InstrumentedFolder) {
            Remove-Item -Recurse -Force $env:InstrumentedFolder
        }
        New-Item -ItemType Directory -Path $env:InstrumentedFolder | Out-Null

        # Create batch file
        @"
        lcd $($env:InstrumentedFolder)
        cd $($env:FusionLiteProject)/Output
        get $($env:InstrumentedFile)
        exit
        "@ | Set-Content "sftp_get.txt"

        sftp -b sftp_get.txt `
             -i id_ecdsa `
             -P $env:FusionLiteServerPort `
             "$env:FusionLiteServerUser@$env:FusionLiteServerHost"
