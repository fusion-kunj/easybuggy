name: Instrument

on:
  workflow_dispatch:

jobs:
  instrument:
    runs-on: self-hosted   # macOS/Linux runner

    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}/target

    env:
      FusionLiteServerHost: ${{ vars.FUSIONLITE_SERVER_HOST }}
      FusionLiteServerPort: ${{ vars.FUSIONLITE_SERVER_PORT }}
      FusionLiteServerUser: ${{ secrets.FUSIONLITE_SERVER_USER }}
      FusionLiteServerKeyFile: ${{ secrets.FUSIONLITE_SERVER_KEY_FILE }}
      FusionLiteProject: ${{ github.event.repository.name }}
      ApplicationFile: ${{ github.event.repository.name }}.jar
      ApplicationInclude: ""
      ApplicationExclude: ""
      InstrumentedFolder: Instrumented
      InstrumentedFile: ${{ github.event.repository.name }}.jar

    steps:

    - name: Print environment variables
      run: |
        echo "FusionLiteServerHost: $FusionLiteServerHost"
        echo "FusionLiteServerPort: $FusionLiteServerPort"
        echo "FusionLiteServerUser: $FusionLiteServerUser"
        echo "FusionLiteServerKeyFile: $FusionLiteServerKeyFile"
        echo "FusionLiteProject: $FusionLiteProject"
        echo "ApplicationFile: $ApplicationFile"
        echo "ApplicationInclude: $ApplicationInclude"
        echo "ApplicationExclude: $ApplicationExclude"
        echo "InstrumentedFolder: $InstrumentedFolder"
        echo "InstrumentedFile: $InstrumentedFile"

    - name: Print current working directory
      run: pwd
    
    - name: Create SSH key file
      run: |
        echo "$FusionLiteServerKeyFile" > id_ecdsa
        chmod 600 id_ecdsa
      shell: bash
      
    - name: Clean Project
      run: |
        cmdtext="Clean:$FusionLiteProject"
        echo "Cmd: $cmdtext"
        ssh -i "$FusionLiteServerKeyFile" -p "$FusionLiteServerPort" \
           "$FusionLiteServerUser@$FusionLiteServerHost" "$cmdtext"
        echo "Clean Project Done"

    - name: Upload Project JAR to Server (SFTP PUT)
      run: |
        cat <<EOF > sftp_put.txt
        cd ${FusionLiteProject}/Input
        put ${ApplicationFile}
        exit
        EOF

        sftp -b sftp_put.txt \
             -i "$FusionLiteServerKeyFile" \
             -P "$FusionLiteServerPort" \
             "$FusionLiteServerUser@$FusionLiteServerHost"

    - name: Preprocess Project
      run: |
        cmdtext="PreProcess:$FusionLiteProject"
        echo "Cmd: $cmdtext"
        ssh -i "$FusionLiteServerKeyFile" -p "$FusionLiteServerPort" \
           "$FusionLiteServerUser@$FusionLiteServerHost" "$cmdtext"

    - name: Instrument Project
      run: |
        cmdtext="Instrument:$FusionLiteProject"
        echo "Cmd: $cmdtext"
        ssh -i "$FusionLiteServerKeyFile" -p "$FusionLiteServerPort" \
           "$FusionLiteServerUser@$FusionLiteServerHost" "$cmdtext"

    - name: PostProcess Project
      run: |
        cmdtext="PostProcess:$FusionLiteProject"
        echo "Cmd: $cmdtext"
        ssh -i "$FusionLiteServerKeyFile" -p "$FusionLiteServerPort" \
           "$FusionLiteServerUser@$FusionLiteServerHost" "$cmdtext"

    - name: Download Instrumented JAR (SFTP GET)
      run: |
        # Clean & create instrumented folder
        rm -rf "$InstrumentedFolder"
        mkdir -p "$InstrumentedFolder"

        # Create SFTP batch file
        cat <<EOF > sftp_get.txt
        lcd ${InstrumentedFolder}
        cd ${FusionLiteProject}/Output
        get ${InstrumentedFile}
        exit
        EOF

        # Execute SFTP
        sftp -b sftp_get.txt \
             -i "$FusionLiteServerKeyFile" \
             -P "$FusionLiteServerPort" \
             "$FusionLiteServerUser@$FusionLiteServerHost"
